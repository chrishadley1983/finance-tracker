# Code Review Report

**Date:** 2026-01-12T20:50:00+00:00
**Mode:** working-tree (staged + unstaged + untracked)
**Files reviewed:** 59 (22 modified + 37 new)
**Commits since last review:** 3

## Verdict: CHANGES_REQUIRED

The changes introduce significant new functionality (Historical FIRE Simulation, Maths Planning, Planning Notes, Account Transactions with Running Balance). Code quality is generally good, but there are **171 failing tests** that must be resolved before merge.

---

## Issues Found

### Critical

1. **171 Test Failures** - Test suite has significant failures across 17 test files
   - `tests/api/accounts.test.ts` - 9 failures
   - `tests/api/budgets.test.ts` - 11 failures
   - `tests/api/categories.test.ts` - 10 failures
   - `tests/api/wealth/net-worth.test.ts` - Multiple failures (500 errors)
   - **Action Required:** Run `npm test` and fix all failures before merging

2. **ESLint Errors (16 errors)** - Several files have ESLint errors that must be fixed:
   - `lib/hooks/useBudgets.ts:46` - `'RequestInit' is not defined`
   - `lib/hooks/useDashboardData.ts:94` - `'RequestInit' is not defined`
   - `lib/import/pdf-extractor.ts` - Multiple `'Buffer' is not defined`
   - `lib/categorisation/ai-categoriser.ts` - `'process' is not defined`
   - **Action Required:** Add `/// <reference lib="dom" />` or configure ESLint for Node.js globals

### Warnings

1. **Unused Variables (30+ warnings)** - Multiple files have unused imports/variables:
   - `components/fire/SimulationSummaryCards.tsx` - Unused imports: Calendar, AlertTriangle, formatCurrencyFull, medianAnnualWithdrawal
   - `lib/fire/historical-simulator.ts` - Unused: historicalReturns, AnnualReturns, yearIndex, cumulativeInflation
   - `components/fire/charts/EndingPortfolioHistogram.tsx` - Unused: ReferenceLine
   - **Action:** Remove unused imports to keep code clean

2. **Line Ending Warnings (CRLF vs LF)** - 13 files will have line endings changed
   - Not blocking, but consider configuring `.gitattributes` for consistency

---

## Code Quality Analysis

### New Features Reviewed

#### 1. Historical FIRE Simulation (`lib/fire/historical-simulator.ts`)
- **Quality:** Good
- **Patterns:** Proper TypeScript types, comprehensive calculations
- **Concern:** No validation of historical data completeness in edge cases
- **Positives:**
  - Well-documented with JSDoc comments
  - Proper handling of different withdrawal strategies
  - Percentile calculations for visualization

#### 2. Maths Planning Calculator (`lib/fire/maths-calculator.ts`)
- **Quality:** Good
- **Patterns:** Clear separation of concerns, utility functions exported
- **Positives:**
  - Date of birth to exact age calculation
  - Iterative approach for compound growth (more accurate than closed-form)
  - Proper formatting utilities

#### 3. Account Transactions with Running Balance (`app/api/accounts/[id]/transactions/route.ts`)
- **Quality:** Acceptable with notes
- **Concern:** Fetches ALL transactions to calculate running balance - could be slow for accounts with many transactions
- **Note:** Uses sentinel value `Number.MIN_SAFE_INTEGER` for pre-snapshot transactions - consider using `null` directly
- **Positives:**
  - Proper pagination with Supabase 1000 row limit handling
  - Good handling of snapshot-based opening balances

#### 4. Planning Notes Feature (`app/api/planning-notes/route.ts`, `lib/validations/planning.ts`)
- **Quality:** Good
- **Patterns:** Proper Zod validation, consistent API patterns
- **Positives:**
  - Full CRUD operations
  - Proper display_order handling
  - Bulk import support

#### 5. Simulation API (`app/api/fire/simulate/route.ts`)
- **Quality:** Good
- **Patterns:** Proper error handling, Zod validation
- **Positives:**
  - Optional yearly data to reduce payload size
  - Helpful GET endpoint documenting parameters

### Modified Files

#### `app/fire/page.tsx`
- **Quality:** Good refactor
- **Change:** Complete rewrite from scenario-based to historical simulation approach
- **Positives:**
  - Tab-based navigation (Simulation, Maths Planning, Settings)
  - Portfolio projection from current savings
  - Good state management with useCallback/useEffect

#### `app/transactions/page.tsx`
- **Quality:** Good enhancement
- **Change:** Added single-account filtering with running balance display
- **Concern:** Duplicated data fetching logic (useTransactions hook + direct fetch)
- **Suggestion:** Consider extracting account-specific fetch into a custom hook

#### `components/accounts/AccountCard.tsx`
- **Quality:** Good
- **Change:** Cards now clickable to view transactions/snapshots
- **Positives:**
  - Different behavior for transactional vs wealth accounts
  - Stale data detection improved

#### `components/transactions/TransactionTable.tsx`
- **Quality:** Good
- **Change:** Added running balance column, hide account column options
- **Positives:**
  - Clean conditional column rendering
  - Proper type extension with TransactionWithRunningBalance

---

## Security Review

### Passed Checks
- No hardcoded secrets or API keys
- No use of `eval()` or `dangerouslySetInnerHTML`
- No SQL injection vulnerabilities (using Supabase client)
- Proper input validation with Zod schemas
- No XSS vulnerabilities detected

---

## Suggestions

1. **Extract Account Transactions Hook** - The `fetchAccountTransactions` logic in `transactions/page.tsx` could be a reusable hook like `useAccountTransactions`

2. **Optimize Running Balance Calculation** - Consider calculating running balance server-side with a database view or window function instead of fetching all transactions

3. **Add Missing Tests** - New features lack test coverage:
   - `lib/fire/historical-simulator.ts` - Has tests but some unused param warnings
   - `lib/fire/maths-calculator.ts` - No tests found
   - Planning Notes API - No tests found

4. **Clean Up ESLint Warnings** - Run `npx eslint --fix` to auto-fix some warnings

---

## Summary

| Metric | Count |
|--------|-------|
| Files Modified | 22 |
| Files Added | 37 |
| ESLint Errors | 16 |
| ESLint Warnings | 30+ |
| Test Failures | 171 |
| Security Issues | 0 |

**Next Steps:**
1. Fix 171 test failures (priority: critical)
2. Fix ESLint errors for Node.js globals
3. Remove unused imports
4. Consider adding tests for new features

---

## Files Reviewed

### Modified Files (22)
- app/accounts/page.tsx
- app/api/budgets/comparison/route.ts
- app/api/budgets/savings-rate/route.ts
- app/api/fire/calculate/route.ts
- app/api/fire/inputs/route.ts
- app/api/wealth-snapshots/route.ts
- app/fire/page.tsx
- app/transactions/page.tsx
- components/accounts/AccountCard.tsx
- components/accounts/AccountList.tsx
- components/fire/FireInputsForm.tsx
- components/fire/index.ts
- components/layout/Sidebar.tsx
- components/transactions/TransactionTable.tsx
- components/transactions/index.ts
- components/wealth/SnapshotHistoryTable.tsx
- components/wealth/index.ts
- lib/supabase/database.types.ts
- lib/types/fire.ts
- package-lock.json
- package.json
- tests/unit/fire-calculator.test.ts

### New Files (37)
- app/api/accounts/[id]/snapshots/[snapshotId]/route.ts
- app/api/accounts/[id]/snapshots/route.ts
- app/api/accounts/[id]/transactions/route.ts
- app/api/fire/simulate/route.ts
- app/api/planning-notes/[id]/route.ts
- app/api/planning-notes/bulk/route.ts
- app/api/planning-notes/reorder/route.ts
- app/api/planning-notes/route.ts
- app/api/planning-sections/[id]/route.ts
- app/api/planning-sections/reorder/route.ts
- app/api/planning-sections/route.ts
- app/planning/page.tsx
- components/fire/MathsPlanningTab.tsx
- components/fire/SimulationConfigForm.tsx
- components/fire/SimulationSummaryCards.tsx
- components/fire/SuccessRateCard.tsx
- components/fire/charts/EndingPortfolioHistogram.tsx
- components/fire/charts/HistoricalProjectionChart.tsx
- components/fire/maths/CoastAnalysisCard.tsx
- components/fire/maths/CurrentPositionCard.tsx
- components/fire/maths/PartnerContributionsCard.tsx
- components/fire/maths/ScenarioComparisonCard.tsx
- components/fire/maths/TargetCalculationCard.tsx
- components/fire/maths/index.ts
- components/planning/AddNoteDialog.tsx
- components/planning/AddSectionDialog.tsx
- components/planning/ImportDialog.tsx
- components/planning/PlanningFilters.tsx
- components/planning/PlanningNoteCard.tsx
- components/planning/PlanningSection.tsx
- components/planning/PlanningSectionList.tsx
- components/planning/index.ts
- components/wealth/WealthSnapshotModal.tsx
- lib/fire/historical-simulator.ts
- lib/fire/maths-calculator.ts
- lib/validations/planning.ts
- tests/unit/historical-simulator.test.ts
